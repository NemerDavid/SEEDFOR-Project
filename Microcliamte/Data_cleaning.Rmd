---
title: "Data_cleaning2"
author: "David"
date: "2024-01-24"
output: html_document
---



```{r, include=FALSE}
options(width = 60)
local({
  hook_output <- knitr::knit_hooks$get('output')
  knitr::knit_hooks$set(output = function(x, options) {
    if (!is.null(options$max.height)) options$attr.output <- c(
      options$attr.output,
      sprintf('style="max-height: %s;"', options$max.height)
    )
    hook_output(x, options)
  })
})
```

```{r, include = FALSE}
library(viridis)
library(dplyr)
library(lubridate)
library(ggplot2)
library(lme4)
library(Matrix)
library(afex)
library(performance)
library(see)
library(broom)
library(readxl)
library(outliers)
library(plotly)
```

### 1. Load and extract the new cleaned rds files in one data frame `combined_data`
```{r, include = FALSE}
###############################################
###  load and extract the new cleaned rds files
###############################################
new_folder_path <- "C:/Users/nemer/Project/Data analysis Git/SEEDFOR-Project/Data/TOMST_Cleaned1"
#### 1-load ###
# Get a list of all RDS files in the folder
rds_files <- list.files(path = new_folder_path, pattern = "\\.rds$", full.names = TRUE)

# Create an empty list to store loaded data frames
loaded_data_frames <- list()

# Loop through each RDS file and load it into R
for (rds_file in rds_files) {
  loaded_data <- readRDS(rds_file)
  loaded_data_frames[[basename(rds_file)]] <- loaded_data
}

#### 2-extract ###
# Example: Extract the first loaded data frame from the list
first_data_frame <- loaded_data_frames[[1]]
head(first_data_frame)
# Create an empty list to store loaded data frames
loaded_data_frames <- list()

# Loop through each RDS file and load it into R
for (rds_file in rds_files) {
  loaded_data <- readRDS(rds_file)
  loaded_data_frames[[basename(rds_file)]] <- loaded_data
}

# Use list2env to create separate data frames in the R environment
list2env(loaded_data_frames, envir = .GlobalEnv)
```

```{r,include=FALSE, echo=4:5, comment=""}
# 3-Combine all loaded data 
# frames into one data frame

combined_data <- do.call(rbind, loaded_data_frames)
rownames(combined_data) <- NULL
```

```{r,include=TRUE}
head(combined_data)
```


### 2. Removing loggers that were out of soil and not working properly
```{r,echo=TRUE,collapse=TRUE}

filtered_data <- combined_data %>%
  filter(!(logger_id %in% c("94200377", "94242031", "94242033", "94242034", "94242039", "94242043", "94242047", "94242059")))

unique(filtered_data$logger_id) # check if the loggers were removed
```



### 3. Load the sensors metadata that contain the information of whether the loggers are inside or outside the cage and add that information to the main dataset
```{r,echo=TRUE}
Sensors_data <- read_excel("C:/Users/nemer/Project/Data analysis Git/SEEDFOR-Project/Data/TOMST metadata/Sensors_20230904.xlsx", 
                           sheet = "capteurs")



# Convert sensor_id in Sensors_data to character and add In_out column 
# that inform us if the logger is inside or outside the cage
Sensors_data <- mutate(Sensors_data, sensor_id = as.character(sensor_id))
# Join the two data sets on logger_id and sensor_id
joined_data <- filtered_data %>%
  left_join(Sensors_data, by = c("logger_id" = "sensor_id")) %>%
  # Select the columns you want from the joined data and filtered data
  select(date, logger_id, T1, T2, T3, soil_moisture, Canopy_openness, Site, In_out)
head(joined_data)

```




### 4. Aggregating the data by season, daily averages, daily min and max temperatues and to daytime (6am-6pm) and nightime (6pm-6am)

```{r,include=FALSE}
#############################
####       Data by Season 
#############################
# Convert date column to a datetime object
joined_data$date <- as.POSIXct(joined_data$date, format="%Y-%m-%d %H:%M:%S")
# Create a new column for the date without the time component
joined_data$day <- as.Date(joined_data$date)
head(joined_data)



Data_by_Season  <- joined_data %>%
  mutate(season = case_when(
    month(date) %in% c(12, 1, 2) ~ "winter",
    month(date) %in% c(3, 4, 5) ~ "spring",
    month(date) %in% c(6, 7, 8) ~ "summer",
    month(date) %in% c(9, 10, 11) ~ "fall"
  ))
```

##### 4.1 Data by season
```{r,echo=TRUE, max.height='100px', attr.output='.numberLines'}

head(Data_by_Season)

```


```{r, include=FALSE}
# Reshape data using gather function
gathered_data <- tidyr::gather(Data_by_Season, key = "Temperature_Variable", value = "Temperature", T1, T2, T3)



# Create a boxplot with all temperature variables on the same plot
## winter ##
# Specify the order of levels for Canopy_openness
canopy_order <- c("Open", "Semi-closed", "Closed")
```

### Winter
```{r, echo=FALSE,fig.width=14, fig.height=14}
gathered_data %>%
  filter(season == 'winter') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%  # Specify order
ggplot( aes(x = Canopy_openness, y = Temperature, fill = Temperature_Variable)) +
  geom_boxplot() +
  labs(title = "Absolute winter temperature for T1, T2, and T3", x = "Site", y = "Temperature °C") +
  theme_minimal()+
  facet_wrap(~Site)+
  theme(text = element_text(size = 22),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)))


```
<div style="margin-bottom: 70px;"></div>


### Spring
```{r, echo=FALSE,fig.width=14, fig.height=14}
## Spring ##
gathered_data %>%
  filter(season=='spring')%>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot( aes(x = Canopy_openness, y = Temperature, fill = Temperature_Variable)) +
  geom_boxplot() +
  labs(title = "Absolute spring temperature for T1, T2, and T3", x = "Site", y = "Temperature °C") +
  theme_minimal()+
  facet_wrap(~Site)+
  theme(text = element_text(size = 22),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)))


```
<div style="margin-bottom: 70px;"></div>


### Summer
```{r, echo=FALSE,fig.width=14, fig.height=14}
## summer ##
gathered_data %>%
  filter(season=='summer')%>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot( aes(x = Canopy_openness, y = Temperature, fill = Temperature_Variable)) +
  geom_boxplot() +
  labs(title = "Absolute summer temperature for T1, T2, and T3", x = "Site", y = "Temperature °C") +
  theme_minimal()+
  facet_wrap(~Site)+
  theme(text = element_text(size = 22),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)))
```
<div style="margin-bottom: 70px;"></div>


### FaLL
```{r, echo=FALSE,fig.width=14, fig.height=14}
## Fall ##
gathered_data %>%
  filter(season=='fall')%>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot( aes(x = Canopy_openness, y = Temperature, fill = Temperature_Variable)) +
  geom_boxplot() +
  labs(title = "Absolute fall temperature for T1, T2, and T3", x = "Site", y = "Temperature °C") +
  theme_minimal()+
  facet_wrap(~Site)+
  theme(text = element_text(size = 22),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)))
```




##### 4.2 Aggregate by daily averages and daily min and max temperatures
```{r,include=FALSE}
#calculate daily averages and daily min and max temperatures
daily_averages_Tmin_Tmax<- Data_by_Season %>%
  group_by(season,day,Canopy_openness,Site,In_out) %>%
  summarize(
    avg_T1 = mean(T1),
    avg_T2 = mean(T2),
    avg_T3 = mean(T3),
    avg_soil_moisture = mean(soil_moisture),
    max_T1 = max(T1),
    min_T1 = min(T1),
    max_T2 = max(T2),
    min_T2 = min(T2),
    max_T3 = max(T3),
    min_T3 = min(T3),
    avg_soil_moisture = mean(soil_moisture),
    max_soil_moisture = max(soil_moisture),
    min_soil_moisture = min(soil_moisture)
  )

```

```{r,echo=TRUE, max.height='100px', attr.output='.numberLines'}

head(daily_averages_Tmin_Tmax)

```


```{r}
####### Daily average #######
# Reshape data using gather function
gathered_data2 <- tidyr::gather(daynight_averages, key = "Temperature_Variable", value = "Temperature °C", avg_T1, avg_T2, avg_T3)



# Specify the order of levels for Canopy_openness
canopy_order <- c("Open", "Semi-closed", "Closed")

```

### Winter
```{r, echo=FALSE,fig.width=14, fig.height=14}
## winter ##
gathered_data2 %>%
  filter(season == 'winter') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%  # Specify order
  ggplot( aes(x = Canopy_openness, y = Temperature, fill = Temperature_Variable)) +
  geom_boxplot() +
  labs(title = "Daily average winter temperature for T1, T2, and T3", x = "Site", y = "Temperature °C") +
  theme_minimal()+
  facet_wrap(~Site)+
  theme(text = element_text(size = 22),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)))


```
<div style="margin-bottom: 70px;"></div>

### Spring
```{r, echo=FALSE,fig.width=14, fig.height=14}
gathered_data2 %>%
  filter(season=='spring')%>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot( aes(x = Canopy_openness, y = Temperature, fill = Temperature_Variable)) +
  geom_boxplot() +
  labs(title = "Daily average spring temperature for T1, T2, and T3", x = "Site", y = "Temperature °C") +
  theme_minimal()+
  facet_wrap(~Site)+
  theme(text = element_text(size = 22),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)))

```
<div style="margin-bottom: 70px;"></div>

### Summer
```{r, echo=FALSE,fig.width=14, fig.height=14}
gathered_data2 %>%
  filter(season=='summer')%>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot( aes(x = Canopy_openness, y = Temperature, fill = Temperature_Variable)) +
  geom_boxplot() +
  labs(title = "Daily average summer temperature for T1, T2, and T3", x = "Site", y = "Temperature °C") +
  theme_minimal()+
  facet_wrap(~Site)+
  theme(text = element_text(size = 22),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)))
```

<div style="margin-bottom: 70px;"></div>
### Fall
```{r, echo=FALSE,fig.width=14, fig.height=14}
gathered_data2 %>%
  filter(season=='fall')%>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot( aes(x = Canopy_openness, y = Temperature, fill = Temperature_Variable)) +
  geom_boxplot() +
  labs(title = "Daily average fall temperature for T1, T2, and T3", x = "Site", y = "Temperature °C") +
  theme_minimal()+
  facet_wrap(~Site)+
  theme(text = element_text(size = 22),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)))

```












##### 4.3 Aggregate to daytime (6am-6pm) and nightime (6pm-6am)
```{r,include=FALSE}
## Aggregate the data to daytime (6am-6pm) and nightime (6pm-6am)
time_of_day <- Data_by_Season %>%
  mutate(time_of_day = ifelse(hour(date) >= 6 & hour(date) < 18, "daytime", "nighttime"))
head(time_of_day)

# Calculate daytime vs. nighttime averages
daynight_averages <- time_of_day %>%
  group_by(season,day,Canopy_openness,Site,time_of_day,In_out) %>%
  summarize(
    avg_T1 = mean(T1),
    avg_T2 = mean(T2),
    avg_T3 = mean(T3),
    avg_soil_moisture = mean(soil_moisture),
    max_T1 = max(T1),
    min_T1 = min(T1),
    max_T2 = max(T2),
    min_T2 = min(T2),
    max_T3 = max(T3),
    min_T3 = min(T3),
    avg_soil_moisture = mean(soil_moisture),
    max_soil_moisture = max(soil_moisture),
    min_soil_moisture = min(soil_moisture)
  )
```
```{r,echo=TRUE, max.height='100px', attr.output='.numberLines'}

head(daynight_averages)

```

```

























```{r,include=FALSE}
#############################
####  Detecting outliers
#############################
summary(Data_by_Season)



# Reshape data using gather function
gathered_data <- tidyr::gather(Data_by_Season, key = "Temperature_Variable", value = "Temperature", T1, T2, T3)

# Create a boxplot with all temperature variables on the same plot
ggplot(gathered_data, aes(x = Temperature_Variable, y = Temperature, fill = Temperature_Variable)) +
                   geom_boxplot() +
                   labs(title = "Boxplots for T1, T2, and T3", x = "Temperature Variables", y = "Temperature") +
                   theme_minimal()+
                   facet_wrap(~ season + Canopy_openness)

### T2 and T3 follow the same trend throughout the different seasons and canopy types, 
### so in the following steps only T1 and T3 will be investigated


library(outliers)

grubbs.test(Data_by_Season$T3)
grubbs.test(Data_by_Season$T1)



### Here is the method in case we want to remove all the outliers above the upper fence and bellow the lower fence
head(Data_by_Season)
# For season and canopy openness #
seasons <- unique(Data_by_Season$season)
canopies <- unique(Data_by_Season$Canopy_openness)
# Create an empty data frame to store the filtered results
joined_data_filtered<- data.frame()

# Loop through each season & canopy types
for (season in seasons) {
  for (canopy in canopies) {
  subset_data <- Data_by_Season[Data_by_Season$season == season & Data_by_Season$Canopy_openness == canopy, ] 
  
  # Calculate IQR for each temperature variable
  iqr_T1 <- IQR(subset_data$T1)
  iqr_T2 <- IQR(subset_data$T2)
  iqr_T3 <- IQR(subset_data$T3)
  
  # Set a threshold as 1.5 times the IQR
  threshold_multiplier <- 1.5
  lower_threshold_T1 <- quantile(subset_data$T1, 0.25) - threshold_multiplier * iqr_T1
  upper_threshold_T1 <- quantile(subset_data$T1, 0.75) + threshold_multiplier * iqr_T1
  
  lower_threshold_T2 <- quantile(subset_data$T2, 0.25) - threshold_multiplier * iqr_T2
  upper_threshold_T2 <- quantile(subset_data$T2, 0.75) + threshold_multiplier * iqr_T2
  
  lower_threshold_T3 <- quantile(subset_data$T3, 0.25) - threshold_multiplier * iqr_T3
  upper_threshold_T3 <- quantile(subset_data$T3, 0.75) + threshold_multiplier * iqr_T3
  
  # Filter out values beyond the thresholds for each season
  subset_data_filtered <- subset_data %>%
    filter(
      T1 >= lower_threshold_T1 & T1 <= upper_threshold_T1,
      T2 >= lower_threshold_T2 & T2 <= upper_threshold_T2,
      T3 >= lower_threshold_T3 & T3 <= upper_threshold_T3
    )
  
  # Append the filtered results to the main data frame
  joined_data_filtered <- rbind(joined_data_filtered, subset_data_filtered)
  }
}

# Print the summary of the filtered data
summary(joined_data_filtered)



### visualize the data after removing the outliers
# Reshape data using gather function
gathered_data2 <- tidyr::gather(joined_data_filtered, key = "Temperature_Variable", value = "Temperature", T1, T2, T3)

# Create a boxplot with all temperature variables on the same plot
ggplot(gathered_data2, aes(x = Temperature_Variable, y = Temperature, fill = Temperature_Variable)) +
                   geom_boxplot() +
                   labs(title = "Boxplots for T1, T2, and T3", x = "Temperature Variables", y = "Temperature") +
                   theme_minimal()+
                   facet_wrap(~ season + Canopy_openness)

```









