---
title: "Data_cleaning2"
author: "David"
date: "2024-01-24"
output: 
  html_document:
   toc: true
  collapsed: false
  smooth_scroll: true
  toc_depth: 4

---


```{r, include=FALSE}
options(width = 60)
local({
  hook_output <- knitr::knit_hooks$get('output')
  knitr::knit_hooks$set(output = function(x, options) {
    if (!is.null(options$max.height)) options$attr.output <- c(
      options$attr.output,
      sprintf('style="max-height: %s;"', options$max.height)
    )
    hook_output(x, options)
  })
})
```

```{r, include = FALSE}
library(viridis)
library(dplyr)
library(lubridate)
library(ggplot2)
library(lme4)
library(Matrix)
library(afex)
library(performance)
library(see)
library(broom)
library(readxl)
library(outliers)
library(plotly)
library(kableExtra)
```

# 1. Load and extract the new cleaned rds files in one data frame 
`combined_data`
```{r, include = FALSE}
###############################################
###  load and extract the new cleaned rds files
###############################################
new_folder_path <- "C:/Users/nemer/Project/Data analysis Git/SEEDFOR-Project/Data/TOMST_Cleaned1"
#### 1-load ###
# Get a list of all RDS files in the folder
rds_files <- list.files(path = new_folder_path, pattern = "\\.rds$", full.names = TRUE)

# Create an empty list to store loaded data frames
loaded_data_frames <- list()

# Loop through each RDS file and load it into R
for (rds_file in rds_files) {
  loaded_data <- readRDS(rds_file)
  loaded_data_frames[[basename(rds_file)]] <- loaded_data
}

#### 2-extract ###
# Example: Extract the first loaded data frame from the list
first_data_frame <- loaded_data_frames[[1]]
head(first_data_frame)
# Create an empty list to store loaded data frames
loaded_data_frames <- list()

# Loop through each RDS file and load it into R
for (rds_file in rds_files) {
  loaded_data <- readRDS(rds_file)
  loaded_data_frames[[basename(rds_file)]] <- loaded_data
}

# Use list2env to create separate data frames in the R environment
list2env(loaded_data_frames, envir = .GlobalEnv)
```

```{r,include=FALSE, echo=4:5, comment=""}
# 3-Combine all loaded data 
# frames into one data frame

combined_data <- do.call(rbind, loaded_data_frames)
rownames(combined_data) <- NULL
```

```{r,include=TRUE}
head(combined_data)
```


# 2. Removing loggers that were out of soil and not working properly
```{r,echo=TRUE,collapse=TRUE}

filtered_data <- combined_data %>%
  filter(!(logger_id %in% c("94200377", "94242031", "94242033", "94242034", "94242039", "94242043", "94242047", "94242059")))

unique(filtered_data$logger_id) # check if the loggers were removed
```



# 3. Load the sensors metadata that contain the information of whether the loggers are inside or outside the cage and add that information to the main dataset
```{r,echo=TRUE}
Sensors_data <- read_excel("C:/Users/nemer/Project/Data analysis Git/SEEDFOR-Project/Data/TOMST metadata/Sensors_20230904.xlsx",  sheet = "capteurs")
#Sensors_data <-read_excel("C:/Users/David/Desktop/SeedFor/Project/SEEDFOR/Field/20230904_MonitoringC1/microclim/Sensors_20230904.xlsx", sheet = "capteurs")


# Convert sensor_id in Sensors_data to character and add In_out column 
# that inform us if the logger is inside or outside the cage
Sensors_data <- mutate(Sensors_data, sensor_id = as.character(sensor_id))
# Join the two data sets on logger_id and sensor_id
joined_data <- filtered_data %>%
  left_join(Sensors_data, by = c("logger_id" = "sensor_id")) %>%
  # Select the columns you want from the joined data and filtered data
  select(date, logger_id, T1, T2, T3, soil_moisture, Canopy_openness, Site, In_out)
head(joined_data)

```




# 4. Aggregating the data by season, daily averages, daily min and max temperatues

```{r,echo=TRUE}
#############################
####       Data by Season 
#############################
# Convert date column to a datetime object
joined_data$date <- as.POSIXct(joined_data$date, format="%Y-%m-%d %H:%M:%S")
# Create a new column for the date without the time component
joined_data$day <- as.Date(joined_data$date)
head(joined_data)



Data_by_Season  <- joined_data %>%
  mutate(season = case_when(
    month(date) %in% c(12, 1, 2) ~ "winter",
    month(date) %in% c(3, 4, 5) ~ "spring",
    month(date) %in% c(6, 7, 8) ~ "summer",
    month(date) %in% c(9, 10, 11) ~ "fall"
  ))


daily_Tmean_Tmin_Tmax <- Data_by_Season %>%
  group_by(season,day,Canopy_openness,Site,In_out) %>%
  summarize(
    avg_T1 = mean(T1),
    avg_T3 = mean(T3),
    max_T1 = max(T1),
    min_T1 = min(T1),
    max_T3 = max(T3),
    min_T3 = min(T3)
  )
```


```{r,echo=TRUE, max.height='100px', attr.output='.numberLines'}

head(daily_Tmean_Tmin_Tmax)

```


## 4.1  Temperatures measured at 8 cm below ground
```{r, include=FALSE}
gathered_data <- tidyr::gather(daily_Tmean_Tmin_Tmax, key = "Temperature_Variable", value = "Temperature", avg_T1, avg_T3,max_T1,max_T3,min_T1,min_T3)
head(gathered_data)

# Specify the order of levels for Canopy_openness
canopy_order <- c("Open", "Semi-closed", "Closed")
```

### 4.1.1 Daily mean temperature measured at 8 cm below ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data %>%
  filter(Temperature_Variable == 'avg_T1') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily mean temperature measured at 8 cm below ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels

```
<div style="margin-bottom: 70px;"></div>


### 4.1.2 Daily maximum temperature measured at 8 cm below ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data %>%
  filter(Temperature_Variable == 'max_T1') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily maximum temperature measured at 8 cm below ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels


```
<div style="margin-bottom: 70px;"></div>


###  4.1.3 Daily minimum temperature measured at 8 cm below ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data %>%
  filter(Temperature_Variable == 'min_T1') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily minimum temperature measured at 8 cm below ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels
```
<div style="margin-bottom: 70px;"></div>

## 4.2  Temperatures measured at 15 cm above ground
### 4.2.1 Daily mean temperature measured at 15 cm above ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data %>%
  filter(Temperature_Variable == 'avg_T3') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily mean temperature measured at 15 cm above ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels

```
<div style="margin-bottom: 70px;"></div>

### 4.2.2 Daily maximum temperature measured at 15 cm above ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data %>%
  filter(Temperature_Variable == 'max_T3') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily maximum temperature measured at 15 cm above ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels

```
<div style="margin-bottom: 70px;"></div>


###  4.2.3 Daily minimum temperature measured at 15 cm above ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data %>%
  filter(Temperature_Variable == 'min_T3') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily minimum temperature measured at 15 cm above ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels
```



# 5. Aggregating the data by season, daily averages, daily min and max temperatues after removing outliers

```{r,include=FALSE}
#############################
####  Detecting outliers
#############################
library(outliers)

grubbs.test(Data_by_Season$T3)
grubbs.test(Data_by_Season$T1)



### Here is the method in case we want to remove all the outliers above the upper fence and bellow the lower fence
head(Data_by_Season)
# For season and canopy openness #
seasons <- unique(Data_by_Season$season)
canopies <- unique(Data_by_Season$Canopy_openness)
# Create an empty data frame to store the filtered results
joined_data_filtered<- data.frame()

# Loop through each season & canopy types
for (season in seasons) {
  for (canopy in canopies) {
  subset_data <- Data_by_Season[Data_by_Season$season == season & Data_by_Season$Canopy_openness == canopy, ] 
  
  # Calculate IQR for each temperature variable
  iqr_T1 <- IQR(subset_data$T1)
  iqr_T2 <- IQR(subset_data$T2)
  iqr_T3 <- IQR(subset_data$T3)
  
  # Set a threshold as 1.5 times the IQR
  threshold_multiplier <- 1.5
  lower_threshold_T1 <- quantile(subset_data$T1, 0.25) - threshold_multiplier * iqr_T1
  upper_threshold_T1 <- quantile(subset_data$T1, 0.75) + threshold_multiplier * iqr_T1
  
  lower_threshold_T2 <- quantile(subset_data$T2, 0.25) - threshold_multiplier * iqr_T2
  upper_threshold_T2 <- quantile(subset_data$T2, 0.75) + threshold_multiplier * iqr_T2
  
  lower_threshold_T3 <- quantile(subset_data$T3, 0.25) - threshold_multiplier * iqr_T3
  upper_threshold_T3 <- quantile(subset_data$T3, 0.75) + threshold_multiplier * iqr_T3
  
  # Filter out values beyond the thresholds for each season
  subset_data_filtered <- subset_data %>%
    filter(
      T1 >= lower_threshold_T1 & T1 <= upper_threshold_T1,
      T2 >= lower_threshold_T2 & T2 <= upper_threshold_T2,
      T3 >= lower_threshold_T3 & T3 <= upper_threshold_T3
    )
  
  # Append the filtered results to the main data frame
  joined_data_filtered <- rbind(joined_data_filtered, subset_data_filtered)
  }
}
summary(joined_data_filtered) 
```

```{r,include=FALSE}
#########################
####       Data by Season 
#########################

daily_Tmean_Tmin_Tmax2 <- joined_data_filtered %>%
  group_by(season,day,Canopy_openness,Site) %>%
  summarize(
    avg_T1 = mean(T1),
    avg_T3 = mean(T3),
    max_T1 = max(T1),
    min_T1 = min(T1),
    max_T3 = max(T3),
    min_T3 = min(T3)
  )
```


```{r,echo=TRUE, max.height='100px', attr.output='.numberLines'}

head(daily_Tmean_Tmin_Tmax)

```


## 5.1  Temperatures measured at 8 cm below ground
```{r, include=FALSE}
gathered_data2 <- tidyr::gather(daily_Tmean_Tmin_Tmax2, key = "Temperature_Variable", value = "Temperature", avg_T1, avg_T3,max_T1,max_T3,min_T1,min_T3)
head(gathered_data2)

# Specify the order of levels for Canopy_openness
canopy_order <- c("Open", "Semi-closed", "Closed")
```

### 5.1.1 Daily mean temperature measured at 8 cm below ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data2 %>%
  filter(Temperature_Variable == 'avg_T1') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily mean temperature measured at 8 cm below ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels

```
<div style="margin-bottom: 70px;"></div>


### 5.1.2 Daily maximum temperature measured at 8 cm below ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data2 %>%
  filter(Temperature_Variable == 'max_T1') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily maximum temperature measured at 8 cm below ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels


```
<div style="margin-bottom: 70px;"></div>


###  5.1.3 Daily minimum temperature measured at 8 cm below ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data2 %>%
  filter(Temperature_Variable == 'min_T1') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily minimum temperature measured at 8 cm below ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels
```
<div style="margin-bottom: 70px;"></div>

## 5.2  Temperatures measured at 15 cm above ground
### 5.2.1 Daily mean temperature measured at 15 cm above ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data2 %>%
  filter(Temperature_Variable == 'avg_T3') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily mean temperature measured at 15 cm above ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels

```
<div style="margin-bottom: 70px;"></div>

### 5.2.2 Daily maximum temperature measured at 15 cm above ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data2 %>%
  filter(Temperature_Variable == 'max_T3') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily maximum temperature measured at 15 cm above ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels

```
<div style="margin-bottom: 70px;"></div>


###  5.2.3 Daily minimum temperature measured at 15 cm above ground
```{r, echo=FALSE,fig.width=20, fig.height=14}
gathered_data2 %>%
  filter(Temperature_Variable == 'min_T3') %>%
  mutate(Canopy_openness = factor(Canopy_openness, levels = canopy_order)) %>%
  ggplot(aes(x = Canopy_openness, y = Temperature, fill = Canopy_openness)) +
  geom_boxplot() +
  labs(title = "Daily minimum temperature measured at 15 cm above ground", x = "Canopy openness", y = "Temperature °C", fill = "Canopy openness") +
  scale_fill_manual(values = c("blue", "green","red")) + # Adjust fill colors for time_of_day
  #theme_minimal() +
  facet_grid(vars(season), vars(Site) , switch = "y") +  # Facet grid by site and time_of_day, with sites on the y-axis
  theme(text = element_text(size = 28),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 50)),
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1))#+
#theme(panel.border = element_rect(color = "black", fill = NA, size = 1))  # Add borders between panels
```










